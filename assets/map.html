<!DOCTYPE html>
<html>
<head>
    <title>OpenStreetMap con Leaflet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        #mapid {
            height: 100vh;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .user-marker-icon {
            background-color: #00d9ff;
            width: 20px;
            height: 20px;
            display: block;
            left: -10px;
            top: -10px;
            position: relative;
            border-radius: 50%;
            border: 3px solid rgb(0, 102, 115);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            animation: pulseblue 1.5s infinite;
        }
        @keyframes pulseblue {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        @keyframes pulsepink {
            0% { box-shadow: 0 0 0 0 rgba(162, 0, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(106, 0, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        .search-marker-icon {
            background-color: #ff0000; /* Un color diferente para el marcador de búsqueda */
            width: 20px;
            height: 20px;
            display: block;
            left: -10px;
            top: -10px;
            position: relative;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        .bus-marker-icon {
            width: 20px;
            height: 20px;
            display: flex; 
            justify-content: center;
            align-items: center;
            
        }

        .bus-marker-icon .bus-icon-container {
            /* Fondo, borde y forma del contenedor */
            border-radius: 50%; /* Forma circular */
            
            /* Dimensiones (ajusta a tu gusto, deben ser menores o iguales a iconSize) */
            width: 30px; 
            height: 30px; 

            /* Centrado de la imagen dentro del contenedor */
            display: flex;
            justify-content: center;
            align-items: center;
            animation: pulsepink 1.5s infinite;
            
        }

        /* Estilo para la imagen real */
        .bus-marker-icon .bus-icon-image {
            /* Asegura que la imagen no se desborde */
            width: 100%; /* Por ejemplo, el 70% del contenedor */
            height: 100%;
            object-fit: contain; /* Asegura que la imagen se vea completa */
        }

    </style>
</head>
<body>
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let busMarkers = {}
        let userMarker = null;
        let allBusStopsData = null;
        let busStopsLayer = null;
        let searchMarker = null; // Nuevo marcador para la ubicación buscada
        let isMapInitialized = false;
        
        const INITIAL_CENTER = { latitude: 10.5000, longitude: -66.9167 }
        const initialLat = INITIAL_CENTER.latitude;
        const initialLon = INITIAL_CENTER.longitude;
        
        function initializeMap() {

            if (isMapInitialized) return;
                map = L.map('mapid', {zoomControl: false}).setView([initialLat, initialLon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19,attribution: ''}).addTo(map);

            // Utilizamos map.whenReady para garantizar que Leaflet esté 100% listo.
                map.whenReady(function() {
                isMapInitialized = true;
            // Solo enviamos el mensaje UNA VEZ aquí
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage('MAP_LOADED');
                }
            });
        }
            initializeMap();

        // 1). Función JS que será llamada desde React Natve para actualizar la ubicación del USUARIO
        window.updateUserMarker = function(lat, lon) {
            const latlng = [lat, lon];
            const userIcon = L.divIcon({
                className: 'user-marker-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
            if (userMarker) {
                userMarker.setLatLng(latlng);
            } else {
                userMarker = L.marker(latlng, { icon: userIcon }).addTo(map)
                    .bindPopup("Estás aquí").openPopup();
            }
                map.setView(latlng, 15);
        };
        // 2). Nueva función JS para marcar una ubicación buscada
        window.updateSearchMarker = function(lat, lon, address) {
          const latlng = [lat, lon];
            const searchIcon = L.divIcon({
                className: 'search-marker-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
            if (searchMarker) {
                searchMarker.setLatLng(latlng);
                searchMarker.setPopupContent(address);
            } else {
                searchMarker = L.marker(latlng, { icon: searchIcon }).addTo(map)
                    .bindPopup(address);
            }
            searchMarker.openPopup();
            // Centrar el mapa en la ubicación buscada
            map.flyTo(latlng, 15, {
                duration: 1.5
            });
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'SEARCH_UPDATED', lat, lon, address }));
        };

        // 3. Función de Renderizado de Paradas (Nueva)
        window.renderBusStops = function(overpassData) {
        // Limpiar paradas anteriores
        if (busStopsLayer) {
            map.removeLayer(busStopsLayer);
        }
        
        busStopsLayer = L.layerGroup().addTo(map);

        if (overpassData && overpassData.elements) {
            
            const stopIcon = L.divIcon({
                className: 'bus-stop-icon',
                html: '<div style="background-color: #0661BC; border-radius: 50%; width: 12px; height: 12px; border: 2px solid white;"></div>', 
                iconSize: [8, 8],
                iconAnchor: [8, 8]
            });

            overpassData.elements.forEach(element => {
                if (element.type === 'node') {
                    const lat = element.lat;
                    const lon = element.lon;
                    const name = (element.tags && element.tags.name) ? element.tags.name : 'Parada de bus';
                    
                    L.marker([lat, lon], { icon: stopIcon })
                        .bindPopup(`<b>Parada:</b> ${name}`)
                        .addTo(busStopsLayer);
                }
            });
            
        }
    
    };
        
        // 4. Función para Renderizar los buses ubicados en la API
        window.renderBusLocations = function(busData) {
            const activeBusIds = new Set();
            const locationBusesMap = {}; // Mapa para agrupar buses por ubicación [lat, lon]

            // 1. Agrupar buses por ubicación exacta para identificar colisiones
            busData.forEach(bus => {
            // Usamos una clave con precisión alta para la agrupación
            const key = `${bus.lat.toFixed(6)},${bus.lon.toFixed(6)}`;
            if (!locationBusesMap[key]) {
                locationBusesMap[key] = [];
            }
            locationBusesMap[key].push(bus);
        });

            // Constante de desplazamiento (ajusta este valor si necesitas más o menos separación)
            const OFFSET = 0.00003; 

            // Icono para los buses (usamos la definición que ya tienes)
            const busIcon = L.divIcon({
                className: 'bus-marker-icon',
                html: '<div class="bus-icon-container"><img src="./assets/img/autobus2.png" class="bus-icon-image" alt="Autobús"></div>', 
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // 2. Iterar sobre las agrupaciones y renderizar con desplazamiento si es necesario
            Object.values(locationBusesMap).forEach(busesInLocation => {
                busesInLocation.forEach((bus, index) => {
                    const { bus_id, lat, lon, route, velocity } = bus;
                    activeBusIds.add(bus_id);

                 let adjustedLat = lat;
                    let adjustedLon = lon;

            // Aplicar desplazamiento solo si hay más de un bus
            if (busesInLocation.length > 1) {
                // Desplazamiento simple: mueve el marcador ligeramente en latitud y longitud
                // El factor 'index' asegura que cada bus se mueva a un lugar diferente
                adjustedLat = lat + (OFFSET * index); 
                adjustedLon = lon + (OFFSET * index * 0.5); // Desplazamiento menor en longitud para dispersar
            }

            const latlng = [adjustedLat, adjustedLon];
            const popupContent = `<b>Bus ${bus_id}</b><br>Ruta: ${route}<br>Velocidad: ${velocity} km/h<br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;

            if (busMarkers[bus_id]) {
                // El marcador ya existe, actualiza su posición
                busMarkers[bus_id].setLatLng(latlng);
                busMarkers[bus_id].setPopupContent(popupContent);
            } else {
                // El marcador no existe, créalo
                busMarkers[bus_id] = L.marker(latlng, { 
                    icon: busIcon,
                    bus_id: bus_id // Añade el ID como una opción para referencia
                })
                .bindPopup(popupContent)
                .addTo(map);
            }
        });
    });

    // 3. Eliminar buses que ya no están en los datos
    Object.keys(busMarkers).forEach(busId => {
        if (!activeBusIds.has(busId)) {
            map.removeLayer(busMarkers[busId]);
            delete busMarkers[busId];
        }
    });
};
        
        map.on('click', function(e) {
            const latlng = { type: 'MAP_CLICK', lat: e.latlng.lat, lng: e.latlng.lng };
            window.ReactNativeWebView.postMessage(JSON.stringify(latlng));
        });
    </script>
</body>
</html>